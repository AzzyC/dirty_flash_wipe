#!/sbin/sh

export ZIPARG2="$2"

my_print() {
	printf '%s\n' "ui_print $1" >> "/proc/self/fd/$ZIPARG2"
}

my_print " "

my_print "Mounting partitions: /data and /cache ..."
mountpoint -q /data || mount /data
mountpoint -q /cache || mount /cache

before_dalvik="$(du -ms /data/dalvik-cache | cut -f1)"
before_resource="$(du -s /data/resource-cache | cut -f1)"
before_cache="$(du -s /cache | cut -f1)"

my_print "Done"
my_print " "

my_print "--- Data ---"
my_print "Wiping /data/dalvik-cache ..."
rm -rf /data/dalvik-cache/*
my_print "Done"

my_print "Wiping /data/resource-cache ..."
rm -rf /data/resource-cache/*
my_print "Done"
my_print " "

my_print "--- Cache ---"
my_print "Wiping /cache ..."

rm -rf /cache/*

my_print "Done"
my_print " "

after_dalvik="$(du -ms /data/dalvik-cache | cut -f1)"
after_resource="$(du -s /data/resource-cache | cut -f1)"
after_cache="$(du -s /cache | cut -f1)"

my_print "/data/dalvik-cache before: ${before_dalvik}mb"
my_print "/data/dalvik-cache after:  ${after_dalvik}mb"
my_print "/data/resource-cache before: ${before_resource}b"
my_print "/data/resource-cache after:  ${after_resource}b"
my_print "/cache before: ${before_cache}b"
my_print "/cache after:  ${after_cache}b"

my_print " "

my_print "Dirty-flash wipe complete!"

exit 0
